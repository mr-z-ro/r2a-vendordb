function toggleChat() {
    $('.card').slideToggle(400, function() { $('.chevron').toggleClass('flipped'); });
    if (localStorage.getItem('chatstate')) {
        localStorage.removeItem('chatstate');
        customGA('send', 'event', 'Chatbot', 'toggle', 'open');
    } else {
        localStorage.setItem('chatstate', 'minimized')
        customGA('send', 'event', 'Chatbot', 'toggle', 'close');
    }
}

var convForm;
function resetChatbot() {
    chatbot_submitted = false;
    // delete the entire convForm generated by the plugin from the page
    $('#chat').remove();

    $('#chat-wrapper').append($chatbotForm);
    $chatbotForm = $('#chat').clone(true);

    // reset the form
    $('#chatbot_form').trigger("reset");

    // call the convForm function again
    convForm = getNewConvForm('.my-conv-form-wrapper');
    toggleChat();
}

var $chatbotForm;
$(document).ready(function() {
    $chatbotForm = $('#chat').clone(true);

    convForm = getNewConvForm('.my-conv-form-wrapper');

    if (localStorage.getItem('chatstate') && localStorage.getItem('chatstate') == 'minimized') {
        toggleChat();
    }

    // Toggle chat window
    $(document).on('click', '#chathead', function() {
        toggleChat();
    });
});

function getNewConvForm(selector) {
    var timeout = isDevelopmentEnviroment() ? 0 : 1200;
    return $(selector).convform({
        eventList: {
            onSubmitForm: sendChatBotForm
        },
        placeHolder: "Write your message...",
        optionPlaceHolder: "Please, select an option...",
        timeOutFirstQuestion : timeout,
        typeInputUi: 'input'
    });
}

function sendChatBotForm(convState) {
    if (isDevelopmentEnviroment()) {
        console.log("Sending form, detected development enviroment. Printing answers:");
        console.log(convState.answers);
        resetChatbot();
        return true;
    }
    convState.form.submit();
    return true;
}

function botga(currentState) {
    customGA('send', 'event', 'Chatbot', 'interaction', JSON.stringify(currentState.answers));
}

<!-- <link rel="stylesheet" href="static/css/site.css"> -->

<style>
    .reset-filters {
        margin: 0px 5px 10px 0px;
        display: inline-block;
    }

    .search-input {
        color: #0a2d37;
        transition: background-image .2s ease-out;
        padding: 12px 12px 12px 45px;
        background: url(/static/images/icon-search.png) no-repeat 15px 50%;
        width: calc(100% - 60px);
        min-height: 20px;
        display: block;
        outline: 0;
        box-sizing: border-box;
    }

    .jBox-content {
        /* max-height: 600px; */
        font-size: 1.4em;
        line-height: 1.4em;
    }
</style>

<div class="header">


    <h1>Regtech for Regulators Vendor Database</h1>


    <div class="sqs-block image-block sqs-block-image sqs-text-ready" data-block-type="5" id="block-bb71bcf01551221b5acb">
        <div class="sqs-block-content" id="yui_3_17_2_1_1534208712486_120">
            <div class="image-block-outer-wrapper layout-caption-hidden design-layout-inline   " id="yui_3_17_2_1_1534208712486_119">
                <div class="intrinsic" style="max-width:2500.0px;" id="yui_3_17_2_1_1534208712486_118">
                    <div style="padding-bottom: 0.8%; overflow: hidden;" class="image-block-wrapper   has-aspect-ratio" data-description="" id="yui_3_17_2_1_1534208712486_117">
                        <noscript>
                            <img src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/" />
                        </noscript>
                        <img class="thumb-image loaded" data-src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image-dimensions="2500x20" data-image-focal-point="0.5,0.5" data-load="false" data-image-id="58ae0a57be659483ad503888"
                            data-type="image" data-position-mode="standard" src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/?format=1000w"
                            data-image-resolution="1000w" style="left: -2.30126%; top: 0%; width: 104.603%; height: 100%; position: absolute;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p>Welcome to the RegTech/SupTech vendor database! Take a closer look at the companies by clicking on one or more of
        the filter tabs below. You can start with any of the filter tabs. </p>

</div>


<div class="loading">
    <h4>Loading...</h4>
    <i class="fas fa-circle-notch fa-spin"></i>
</div>


<div id="vendor-db" class="sqs-layout sqs-grid-12 columns-12 content " style="display:none; margin-top: 30px;">
    <div class="row sqs-row">
        <div class="col sqs-col-4 accordian-selections">

            <ul id="filters" uk-accordion="multiple: false">
                <!-- Why does this prevent opening mail? -->
                <li style="display:none;">
                    <a class="uk-accordion-title" href="#">
                        Category
                        <i class="fa fa-industry m-l-sm"></i>
                    </a>
                    <div id='category-choices' class="uk-accordion-content"> </div>
                </li>


                <li style="margin-top:0px;">
                    <a class="uk-accordion-title" href="#">
                        Category
                        <i class="fa fa-industry m-l-sm"></i>
                    </a>
                    <div id='categories-choices' class="uk-accordion-content"> </div>
                </li>
                <li>
                    <a class="uk-accordion-title" href="#">
                        Use Cases
                        <i class="fa fa-list m-l-sm"></i>
                    </a>
                    <div id='useCases-choices' class="uk-accordion-content"> </div>
                </li>
                <li>
                    <a class="uk-accordion-title" href="#">
                        Technology
                        <i class="fa fa-cogs m-l-sm"></i>
                    </a>
                    <div id='tech-choices' class="uk-accordion-content"> </div>
                </li>
                <li>
                    <a class="uk-accordion-title" href="#">
                        Location Availability
                        <i class="fa fa-map m-l-sm"></i>
                    </a>
                    <div id='locations-choices' class="uk-accordion-content"> </div>
                </li>
            </ul>
        </div>

        <div class="col sqs-col-8">

            <div class="row sqs-row">
                <div class="col sqs-col-8">
                    <div id="map">
                    </div>
                </div>
            </div>

            <div class="row sqs-row" style="margin-bottom: 10px">
                <div class="col sqs-col-4">
                    <div class="reset-filters dark-border dark-button">Reset Filters</div>
                    <span style="display:inline-block;">&nbsp;</span>
                </div>
                <div class="col sqs-col-4">
                    <div class="autocomplete">
                        <input id="search-box" type="search" class="search-input dark-border" value="" placeholder="Search">
                    </div>
                </div>
            </div>

            <div class="row sqs-row" style="margin-bottom: 10px">
                <div class="col sqs-col-8">
                    <div id="selected-filter"> </div>
                </div>
            </div>

            <div class="row sqs-row">
                <div class="col sqs-col-6">
                    <div class="instruction-text">
                        <span>Click on a company below to explore.</span>
                    </div>
                </div>
                <div class="col sqs-col-2">
                    <div class="solutions-number-container">
                        <span id="solutions-number"></span>
                    </div>
                </div>
            </div>

            <div class="row sqs-row">
                <div id="vendor-list" class="col sqs-col-8 tile-grid">
                </div>
            </div>


            <div class="row sqs-row">
                <div class="sqs-block button-block sqs-block-button" data-block-type="53" id="block-yui_3_17_2_1_1524083958927_9987" style="padding-top: 20px;">
                    <div class="sqs-block-content" id="yui_3_17_2_1_1534259152465_183">
                        <div class="sqs-block-button-container--center" data-alignment="center" data-button-size="medium" id="yui_3_17_2_1_1534259152465_182">
                            <a href="https://docs.google.com/forms/d/e/1
                                    AIpQLSc4srjLTgwozGTdQbWDyH6BHTFWpO7YREbJ8qu8Am6JrEWl4Q/viewform" class="sqs-block-button-element--medium sqs-block-button-element"
                                data-initialized="true" target="_blank" id="yui_3_17_2_1_1534259152465_387">Don't
                                see your company listed? Apply here.</a>
                        </div>
                    </div>
                </div>

                <div class="sqs-block button-block sqs-block-button" data-block-type="53" id="block-yui_3_17_2_1_1524083958927_9987" style="padding-top: 20px;">
                    <div class="sqs-block-content" id="yui_3_17_2_1_1534259152465_183">
                        <div class="sqs-block-button-container--center" data-alignment="center" data-button-size="medium" id="yui_3_17_2_1_1534259152465_182">
                            <a href="mailto:R2A@bfaglobal.com" class="sqs-block-button-element--medium sqs-block-button-element" data-initialized="true">Contact
                                Us
                            </a>
                        </div>
                    </div>
                </div>


            </div>

        </div>
    </div>

</div>

<div class="footer">
    <div class="sqs-block horizontalrule-block sqs-block-horizontalrule" data-block-type="47" id="block-yui_3_17_2_17_1485376301511_24615">
        <div class="sqs-block-content">
            <hr>
        </div>
    </div>
    <p>By using this resource, you understand that R<sup>2</sup>A is not endorsing any of the vendors listed below, and bears
        no responsibility for any subsequent contact, conversation, transfer of information, procurement, and legal contracting.
        The tool is intended as a reference for regulators and financial authorities seeking information on potential vendors
        for technology that can aid in the creation of RegTech solutions.</p>
</div>


<section id="chatbot">
    <div class="sqs-row chatbot-header">
        <span class="chatbot-title">R2A Assistant</span>
        <span class="chatbot-header-buttons">
            <span class="chatbot-refresh tooltip-bottom" title="Restart the chatbot conversation">
                <i class="fa fa-sync-alt m-r-sm m-l-xs"></i>
            </span>
            <a href="https://goo.gl/forms/cgykBXq1F03gAJof2" target="_blank">
                <span class="chatbot-feedback tooltip-bottom" title="Give us feedback from the chatbot">
                    <i class="fa fa-comment-alt m-l-xs"></i>
                </span>
            </a>
            <i class="fa chatbot-toggle fa-angle-down chatbot-collapse-arrow m-r-sm m-l-sm"></i>
        </span>
    </div>
    <div class="sqs-row chatbot-main">
        <iframe id="chatbot-iframe" allow="microphone;" width="350" height="700" src="https://console.dialogflow.com/api-client/demo/embedded/e64bb45d-92f0-4e28-809d-7cbd9971a97e">
        </iframe>
    </div>
    <div class="sqs-row chatbot-footer">
    </div>
</section>


<script src="./static/js/data-formatter.js"></script>

<script src="./static/components/map/map.js"></script>
<link rel="stylesheet" href="static/components/map/map.css">

<script src="./static/components/accordian/accordian.js"></script>
<link rel="stylesheet" href="static/components/accordian/accordian.css">

<script src="./static/components/autocomplete/autocomplete.js"></script>
<link rel="stylesheet" href="static/components/autocomplete/autocomplete.css">

<script src="./static/components/filterbar/filterbar.js"></script>
<link rel="stylesheet" href="static/components/filterbar/filterbar.css">

<script src="./static/components/tile-grid/tile-grid.js"></script>
<link rel="stylesheet" href="static/components/tile-grid/tile-grid.css">


<!-- <script src="static/js/data-loader.js" type="text/javascript"></script> -->
<script src="static/js/filtering-ui.js" type="text/javascript"></script>


<script>




    var allVendors = [];
    var allCategories = [];
    var allUseCases = [];
    var allLocations = [];
    var selectedVendors = [];

    var filterOptions = {
        categories: [],
        useCases: [],
        tech: [],
        locations: [],
        names: [],
    }

    var selectedFilters = {
        categories: [],
        useCases: [],
        tech: [],
        locations: [],
        names: [],
    }

    Promise.all([
        //Vendor Data
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5KSq8h57Cvah8_VknwXIu7WM1VsZ9Z1Rm1JQ8i2ETOdRttk3H4X24Q-ZaAEheEfI12x5IPrkqL0Ok/pub?gid=1889907117&single=true&output=csv"),
        //Persona
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5KSq8h57Cvah8_VknwXIu7WM1VsZ9Z1Rm1JQ8i2ETOdRttk3H4X24Q-ZaAEheEfI12x5IPrkqL0Ok/pub?gid=1319999360&single=true&output=csv"),
        //Objective
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5KSq8h57Cvah8_VknwXIu7WM1VsZ9Z1Rm1JQ8i2ETOdRttk3H4X24Q-ZaAEheEfI12x5IPrkqL0Ok/pub?gid=1801467124&single=true&output=csv"),
        //Technologies
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5KSq8h57Cvah8_VknwXIu7WM1VsZ9Z1Rm1JQ8i2ETOdRttk3H4X24Q-ZaAEheEfI12x5IPrkqL0Ok/pub?gid=1600251903&single=true&output=csv"),
    ]).then((data) => {

        console.log(data)

        // Format Data
        formatData(data)


        // Set the UI
        autocomplete(
            document.getElementById("search-box"),
            Object.keys(filterOptions).reduce((acc, filterKey) => {
                return acc.concat(filterOptions[filterKey])
            }, []).sort(), selected => {
                $("#search-box").val("")
                key = findFilterKeyForValue(filterOptions, selected)
                removeAllFilters()
                addFilter(key, selected, updateUI)
            });

        updateUI()

        setTimeout(() => {
            UIkit.accordion('#filters').toggle(1, true);
        }, 1000)

        applyFiltersInURL()

        // Hide Loading & Show Tracker
        $(".loading").css("display", "none")
        $("#vendor-db").css("display", "block")


    }).catch(error => {
        if (error) {
            console.error("Caught Error:", error)
        }
    })

    function applyFiltersInURL() {

        applyQueryParamFilter('use-case', allUseCases, 'useCases', (value) => value.name.trim())
        applyQueryParamFilter('technology', allTech, 'tech', (value) => value.name.trim())
        applyQueryParamFilter('country', filterOptions.locations, 'locations')

        updateUI()
    }

    function applyQueryParamFilter(queryParam, arr, filterGroup, unpack) {
        param = (new URL(location)).searchParams.get(queryParam)
        console.log("param", param, arr)
        if (param != undefined && param != '') {
            value = param
            if (unpack !== undefined) {
                value = unpack(objectWithValue(param, arr))
            }
            if (filterOptions[filterGroup].indexOf(value) !== -1){
                addFilter(filterGroup, value)
            }
        }
    }

    // Format Data
    function formatData(data) {

        allVendors = data[0]
        allCategories = data[1]
        allUseCases = data[2]
        allTech = data[3]

        allCategories.forEach(category => {
            category.objectiveArr = category.objectives.split(',')
        })


        allVendors.forEach((vendor) => {
            filterOptions.names.push(vendor.name.trim())
            const useCasePropName = 'objective'
            if (useCasePropName in vendor) {
                vendor.objectiveIds = vendor[useCasePropName].split(',')
                vendor.useCases = vendor.objectiveIds.map(objectiveId => {
                    return objectWithValue(objectiveId, allUseCases).name.trim()
                })
                vendor.categoryIDs = []
                vendor.categories = []
                allCategories.forEach(category => {
                    idIntersection = category.objectiveArr.filter(value => (vendor.objectiveIds.indexOf(value) !== -1))
                    if (idIntersection.length >= 1) {
                        vendor.categoryIDs.push(category.id)
                        vendor.categories.push(category.name)
                    }
                })
            }

            const techPropName = 'technology'
            if (techPropName in vendor) {
                vendor.technologyIds = vendor[techPropName].split(',')
                vendor.tech = vendor.technologyIds.map(technologyId => {
                    return objectWithValue(technologyId, allTech).name.trim()
                })
            }

            const locationAvailabilityName = 'geographies'

            if (locationAvailabilityName in vendor) {
                vendor.locationAvailability = vendor[locationAvailabilityName].split(',')
                vendor.locationAvailability.forEach(locationAvailabile => {
                    if (filterOptions.locations.indexOf(locationAvailabile) === -1) {
                        filterOptions.locations.push(locationAvailabile)
                    }
                })
            }
        })
        console.log('allVendors', allVendors)

        // var nestedVendors = d3.nest()
        //     .key(function (d) { return d.Agency; })
        //     .entries(allVendors);

        // groupedSolutions = nestedVendors.reduce((acc, element) => {
        //     acc[element.key] = element.values
        //     return acc
        // }, {})


        filterOptions.categories = uniqueProperties(allVendors, 'categories').sort()
        console.log('filterOptions.categories', filterOptions.categories)
        filterOptions.useCases = uniqueProperties(allVendors, 'useCases').sort()
        console.log('filterOptions.useCases', filterOptions.useCases)
        filterOptions.tech = uniqueProperties(allVendors, 'tech').sort()
        console.log('filterOptions.tech', filterOptions.tech)
        console.log('filterOptions.locations', filterOptions.locations)

    }


    // UI Updates 
    function updateUI() {
        selectedVendors = vendorsMatchingFilters(allVendors, selectedFilters)
        $('#solutions-number').html(selectedVendors.length + (selectedVendors.length === 1 ? ' company' : ' companies'))
        updateResetButtonVisibility()
        updateSelectedFiltersUI('#selected-filter', selectedFilters, (event) => {
            removeFilter(event.currentTarget.innerText, updateUI)
        })
        updateVendorTiles()
        updateAccordianFilters()
    }

    function updateResetButtonVisibility() {
        style = (filterCount(selectedFilters) ? 'inline-block' : 'none')
        $(".reset-filters").css('display', style)
    }

    $('.reset-filters').click(event => {
        removeAllFilters(updateUI)
    })

    function updateVendorTiles() {
        updateTileGrid(
            "#vendor-list",
            selectedVendors
            , {
                emptyText: "There are no solutions available with the selected filters.<br />Review current filters on the left-hand side. ",
                idMap: (el) => { return el.id },
                tileContent: imageForVendor,
                tileSelected: (id) => {
                    displayVendor(id)
                }
            })
    }

    function updateAccordianFilters() {

        availableCategoryFilters = undefined
        availableUseCaseFilters = undefined
        if (selectedFilters.categories.length >= 1) {
            availableCategoryFilters = []
            category = objectWithValue(selectedFilters.categories[0], allCategories, 'name')
            availableUseCaseFilters = category.objectiveArr.map(useCaseID => {
                return objectWithValue(useCaseID, allUseCases).name.trim()
            })
        }
        displayAccordianValues(filteredFilters('categories', selectedFilters.categories, availableCategoryFilters), accordianConfigForFilterKey('categories'))
        displayAccordianValues(filteredFilters('useCases', selectedFilters.useCases, availableUseCaseFilters), accordianConfigForFilterKey('useCases'))

        displayAccordianValues(filteredFilters('tech', selectedFilters.tech), accordianConfigForFilterKey('tech'))
        displayAccordianValues(filteredFilters('locationAvailability', selectedFilters.locations), accordianConfigForFilterKey('locations'))
    }

    function accordianConfigForFilterKey(key) {
        return {
            elementId: '#' + key + '-choices',
            selected: accordianSelectionForFilterType(key),
            mouseover: accordianMouseoverForFilterType(key),
            mouseout: event => { $('.uk-badge').remove() },
            emptyText: "All options selected"
        }
    }

    function accordianSelectionForFilterType(filterType) {
        return (event) => {
            $('.uk-badge').remove()
            addFilter(filterType, event.target.innerText, updateUI)
        }
    }

    function accordianMouseoverForFilterType(filterType) {
        return (event) => {
            copiedFilters = jQuery.extend(true, {}, selectedFilters);
            copiedFilters[filterType].push(event.target.innerText)
            matched = vendorsMatchingFilters(selectedVendors, copiedFilters)
            $(event.target).append('<span class="uk-badge">' + matched.length + '</span>')
        }
    }

    function displayVendor(vendorId) {
        vendor = objectWithValue(vendorId, allVendors)
        console.log("Display", vendor)

        modal = $('.vendor').jBox('Modal', {
            maxWidth: 600
        });

        modal.setTitle(`<span class="vendor-modal-title-text">` + vendor.name + `</span>
                <i class="fa fa-times vendor-modal-close-times" onclick="modal.close();"></i>`)

        content = `
            <div class="sqs-row vendor-modal-logo">` + imageForVendor(vendor) + `</div>
            <div class="sqs-row justify">
                <span class="vendor-modal-description-text">` + vendor.description + `</span>
            </div>
            <div class="sqs-row vendor-modal-details">`

        content += vendor.location ? `<p><span><i class="fa fa-map-marker m-r-sm"></i><strong>Location: </strong>` + vendor.location + `</span></p>` : '';
        console.log(content)
        if (vendor.contact.indexOf('@') >= 0) {
            content += vendor.contact ? `<p><span><i class="fa fa-envelope m-r-sm"></i><strong>Email: </strong><a class="vendor-modal-url" target="_blank" href="mailto:` + vendor.contact + `"> ` + vendor.contact + `</a></span></p>` : '';
        } else {
            content += vendor.contact ? `<p><span><i class="fa fa-phone m-r-sm"></i><strong>Contact:</strong>` + vendor.contact + `</span></p>` : '';
        }

        content += vendor.url ? `
                <p><span><i class="fa fa-external-link-square-alt m-r-sm"></i><strong>Website: </strong> 
                    <span class="vendor-modal-url"><a target="_blank" href="http://` + vendor.url + `">` + vendor.url + `</a></span>
                </span></p>` : ''

        content += `
                <p><span><i class="fa fa-cogs m-r-xs"></i><strong>Technologies: </strong>` + vendor.tech.join(', ') + `</span></p>
                <p><span><i class="fa fa-globe m-r-xs"></i><strong>Availability: </strong>` + vendor.locationAvailability.join(', ') + `</span></p>
            </div>
        </div>`

        modal.setContent(content).open();
    }

    function imageForVendor(vendor) {
        return `<object class="tile-image" data="` + vendor.logo_url + `" type="image/png">
                    <img class="tile-image" src="` + ((vendor.backup_logo_url !== undefined && vendor.backup_logo_url !== '') ? vendor.backup_logo_url : vendor.logo_url) + `" />
                </object>`
    }


    // Helper Functions
    function vendorsMatchingFilters(vendors, matchFilters) {
        var matchedVendors = [];

        vendors.forEach(vendor => {
            var matchesAllFilters = true;
            Object.keys(matchFilters).forEach(filterKey => {
                var filters = matchFilters[filterKey]
                if (filterKey === 'categories') {
                    filters.forEach(filter => {
                        if (vendor.categories.indexOf(filter) === -1) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'useCases') {
                    filters.forEach(filter => {
                        if (vendor.useCases.indexOf(filter) === -1) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'tech') {
                    filters.forEach(filter => {
                        if (vendor.tech.indexOf(filter) === -1) {
                            matchesAllFilters = false
                        }
                    })
                }

                if (filterKey === 'locations') {
                    filters.forEach(filter => {
                        if (vendor.locationAvailability.indexOf(filter) === -1) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'names') {
                    filters.forEach(filter => {
                        if (vendor.name.trim() !== filter.trim()) {
                            matchesAllFilters = false
                        }
                    })
                }

            })
            if (matchesAllFilters) {
                matchedVendors.push(vendor)
            }
        })

        return matchedVendors
    }

    function filteredFilters(key, selections, remainingFilters) {
        if (!remainingFilters) remainingFilters = uniqueProperties(selectedVendors, key).sort();
        selections.forEach(filter => {
            index = remainingFilters.indexOf(filter)
            if (index !== -1) {
                remainingFilters.splice(index, 1)
            }
        })
        return remainingFilters
    }

    function objectWithValue(id, arr, property) {
        if (!property) property = 'id';
        areturn = arr.reduce((acc, el) => {
            foundProperty = el[property]
            if (foundProperty && foundProperty.trim() === id.trim()) {
                acc = el
            }
            return acc;
        }, '')
        return areturn

    }

</script>
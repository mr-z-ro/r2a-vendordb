<link rel="stylesheet" href="static/js/leaflet/leaflet.css" />
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="static/js/leaflet/leaflet.js"></script>
<script src="static/js/d3/d3.min.js"></script>


<style>
    /* Needs Media Queries! */

    /* .header {
        margin: 20px 20px;
        font-weight: normal;
    }

    .header>h1 {
        margin-top: 50px;
    } */

    .header>p>a {
        color: #2C9385;
    }

    #mapid {
        height: 40vw;
    }

    .loading {
        text-align: center;
        margin: 275px 0px;
    }

    .loading>i {
        font-size: 40px;
        color: #2C9385;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        line-height: 18px;
        color: #555;
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    /* @media only screen and (min-width: 768px) { */

    /* For mobile phones: */

    /* .header {
            margin: 20px 188px;
            font-weight: normal;
        }
    } */
</style>



<div class="header">
    <h1>RegTech Deployment Tracker</h1>

    <div class="sqs-block image-block sqs-block-image sqs-text-ready" data-block-type="5" id="block-bb71bcf01551221b5acb">
        <div class="sqs-block-content" id="yui_3_17_2_1_1534208712486_120">
            <div class="image-block-outer-wrapper layout-caption-hidden design-layout-inline   " id="yui_3_17_2_1_1534208712486_119">
                <div class="intrinsic" style="max-width:2500.0px;" id="yui_3_17_2_1_1534208712486_118">
                    <div style="padding-bottom: 0.8%; overflow: hidden;" class="image-block-wrapper   has-aspect-ratio" data-description="" id="yui_3_17_2_1_1534208712486_117">
                        <noscript>
                            <img src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/" />
                        </noscript>
                        <img class="thumb-image loaded" data-src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image-dimensions="2500x20" data-image-focal-point="0.5,0.5" data-load="false" data-image-id="58ae0a57be659483ad503888"
                            data-type="image" data-position-mode="standard" src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/?format=1000w"
                            data-image-resolution="1000w" style="left: -2.30126%; top: 0%; width: 104.603%; height: 100%; position: absolute;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p>This map will be updated to reflect RegTech deployments around the world. Don't see your country's solution listed? Contact
        us at
        <a href="mailto:R2A@bfaglobal.com">R2A@bfaglobal.com</a>.</p>
</div>

<!-- <iframe width="100%" height="520" frameborder="0" src="https://bfaglobal.carto.com/u/bfglobal-admin/builder/c2a72170-bd93-436a-9fb2-067fd9706bcb/embed"
    allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe> -->

<div id="contents">
    <div class="loading">
        <h4>Loading...</h4>
        <i class="fas fa-circle-notch fa-spin"></i>
    </div>
</div>



<script>

    // setTimeout(function () { //Simulate loading conditions
    var categories = ['Exploratory', 'Developmental', 'Operational']


    Promise.all([
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTYPKjQhh6VuHPB0fezf1fOH4s90BSbrVNjYP5QHGAwtJTeYmB1vGxrZQHKtkgHlNxAsdITJu5g5J6p/pub?gid=553555379&single=true&output=csv"),
        d3.json("./static/js/leaflet/countries.json")
    ]).then((data) => {

        var contents = document.getElementById('contents');
        contents.innerHTML = '<div id="mapid"></div>'
        var map = L.map('mapid', {
            zoomSnap: 0.05
        });

        // create the tile layer with correct attribution
        var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, { minZoom: 1, maxZoom: 4, attribution: osmAttrib });

        // start the map in South-East England
        var initialZoom = 2.25
        map.setView(new L.LatLng(25.307577, 1.743395), initialZoom);
        map.fitBounds([
            [66.263456, -177.891759],
            [-27.816707, 144.109652],
            [62.613873, 178.533777]
        ])
        map.addLayer(osm);

        const deployments = data[0]
        const countryShapes = data[1]['features']

        console.log(countryShapes)
        const mapData = deployments.reduce((acc, deployment) => {
            deployment.Country = deployment.Country.trim()

            var countryShape = countryShapes.filter(shape => {
                return shape.properties.country_name === deployment.Country |
                    (shape.properties.alternative_names.indexOf(deployment.Country) !== -1)
            })[0]

            if (countryShape !== undefined) {
                var foundShapeDeployment = acc.filter(shapeDeployments => {
                    return shapeDeployments.properties.country_name === countryShape.properties.country_name
                })[0]
                if (foundShapeDeployment !== undefined) {
                    foundShapeDeployment.properties.deployments.push(deployment)
                } else {
                    countryShape.properties.deployments = [deployment];
                    acc.push(countryShape)
                }
            } else { console.warn("Could Not Find Shape for Country", deployment.Country, ) }

            return acc
        }, []);

        console.log("Map Data", mapData)

        var geojson;
        geojson = L.geoJson(mapData, { style: style }).addTo(map);

        function getColor(d) {
            return d >= 2 ? '#1b988a' :
                d >= 1 ? '#16716a' :
                    '#104949';
        }

        function highestIndexOfDeplyments(deployments) {
            var found = -1
            categories.slice().reverse().forEach((cat, idx) => {
                if (deployments.filter(e => { return e.Status.trim() === categories[idx] }).length > 0) {
                    found = idx
                }
            })
            return found
        }

        function style(feature) {
            var color = getColor(highestIndexOfDeplyments(feature.properties.deployments))
            return {
                fillColor: color,
                fillOpacity: 0.5,
                weight: 2,
                opacity: .5,
                color: color,
                // dashArray: 3,
            };
        }

        function highlightFeature(e) {
            var color = getColor(highestIndexOfDeplyments(e.target.feature.properties.deployments))
            var layer = e.target;

            layer.setStyle({
                // weight: 5,
                color: color,
                dashArray: '',
                opacity: 1,
                fillOpacity: 0.7
            });

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }

            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            geojson.resetStyle(e.target);
            info.update();
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        geojson = L.geoJson(mapData, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);

        // Hover over

        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed
        info.update = function (properties) {
            var infoText = ""
            if (properties) {
                infoText += '<b>' + properties.country_name + '</b><br />' + properties.deployments.length + ' use cases:<p><ul>'
                properties.deployments.forEach(deployment => {
                    infoText += "<li>" + deployment["Use case"].trunc(30) + "</li>"
                })
                infoText += "</ul>"

            } else {
                infoText = 'Hover over a country'
            }
            this._div.innerHTML = infoText
        };

        info.addTo(map);

        // Legend

        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                labels = [];

            // div.innerHTML += '<h4>Deployments</h4>'
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < categories.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(i) + '"></i> ' + categories[i] + '<br>';
            }

            return div;
        };

        legend.addTo(map);

        String.prototype.trunc =
            function (n) {
                return this.substr(0, n - 1) + (this.length > n ? '&hellip;' : '');
            };

        map.invalidateSize()
    })
    // }, 3000);



</script>
<link rel="stylesheet" href="static/js/leaflet/leaflet.css" />
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="static/js/leaflet/leaflet.js"></script>
<script src="static/js/d3/d3.min.js"></script>


<style>
    /* Needs Media Queries! */

    .header {
        margin: 20px 20px;
        font-weight: normal;
    }

    .header>h1 {
        margin-top: 50px;
    }

    .header>p>a {
        color: #2C9385;
    }

    #mapid {
        height: 620px;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        line-height: 18px;
        color: #555;
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    @media only screen and (min-width: 768px) {
        /* For mobile phones: */
        .header {
            margin: 20px 188px;
            font-weight: normal;
        }
    }
</style>



<div class="header">
    <h1>RegTech Deployment Tracker</h1>
    <p>This map will be updated to reflect RegTech deployments around the world. Don't see your country's solution listed? Contact
        us at
        <a href="mailto:R2A@bfaglobal.com">R2A@bfaglobal.com</a>.</p>
</div>

<!-- <iframe width="100%" height="520" frameborder="0" src="https://bfaglobal.carto.com/u/bfglobal-admin/builder/c2a72170-bd93-436a-9fb2-067fd9706bcb/embed"
    allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe> -->

<div id="mapid"></div>



<script>
    var map = L.map('mapid');

    // create the tile layer with correct attribution
    var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib = 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.TileLayer(osmUrl, { minZoom: 2, maxZoom: 4, attribution: osmAttrib });

    // start the map in South-East England
    map.setView(new L.LatLng(25.307577, 1.743395), 2);
    map.addLayer(osm);

    Promise.all([
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTYPKjQhh6VuHPB0fezf1fOH4s90BSbrVNjYP5QHGAwtJTeYmB1vGxrZQHKtkgHlNxAsdITJu5g5J6p/pub?gid=553555379&single=true&output=csv"),
        d3.json("./static/js/leaflet/countries.json")
    ]).then((data) => {
        const deployments = data[0]
        const countryShapes = data[1]['features']

        console.log(countryShapes)
        const mapData = deployments.reduce((acc, deployment) => {
            deployment.Country = deployment.Country.trim()

            var countryShape = countryShapes.filter(shape => {
                return shape.properties.country_name === deployment.Country |
                    (shape.properties.alternative_names.indexOf(deployment.Country) !== -1)
            })[0]

            if (countryShape !== undefined) {
                var foundShapeDeployment = acc.filter(shapeDeployments => {
                    return shapeDeployments.properties.country_name === countryShape.properties.country_name
                })[0]
                if (foundShapeDeployment !== undefined) {
                    foundShapeDeployment.properties.deployments.push(deployment)
                } else {
                    countryShape.properties.deployments = [deployment];
                    acc.push(countryShape)
                }
            } else { console.warn("Could Not Find Shape for Country", deployment.Country, ) }

            return acc
        }, []);

        var geojson;
        geojson = L.geoJson(mapData, { style: style }).addTo(map);

        function getColor(d) {
            return d > 11 ? '#0b2229' :
                d > 9 ? '#0e3639' :
                    d > 5 ? '#104949' :
                        d > 4 ? '#135d5a' :
                            d > 3 ? '#16716a' :
                                d > 2 ? '#18847a' :
                                    '#1b988a';
        }

        function style(feature) {
            var color = getColor(feature.properties.deployments.length)
            return {
                fillColor: color,
                fillOpacity: 0.5,
                weight: 2,
                opacity: .5,
                color: color,
                // dashArray: 3,
            };
        }

        function highlightFeature(e) {
            var color = getColor(e.target.feature.properties.deployments.length)
            var layer = e.target;

            layer.setStyle({
                // weight: 5,
                color: color,
                dashArray: '',
                opacity: 1,
                fillOpacity: 0.7
            });

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }

            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            geojson.resetStyle(e.target);
            info.update();
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        geojson = L.geoJson(mapData, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);

        // Hover over

        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed
        info.update = function (properties) {
            var infoText = ""
            if (properties) {
                infoText += '<b>' + properties.country_name + '</b><br />' + properties.deployments.length + ' use cases:<p><ul>'
                properties.deployments.forEach(deployment => {
                    infoText += "<li>" + deployment["Use case"].trunc(30) + "</li>"
                })
                infoText += "</ul>"

            } else {
                infoText = 'Hover over a country'
            }
            this._div.innerHTML = infoText
        };

        info.addTo(map);

        // Legend

        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = [1, 2, 3, 4, 5, 9, 11],
                labels = [];

            // div.innerHTML += '<h4>Deployments</h4>'
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '<br>' : '+');
            }

            return div;
        };

        legend.addTo(map);

        String.prototype.trunc =
            function (n) {
                return this.substr(0, n - 1) + (this.length > n ? '&hellip;' : '');
            };
    })
</script>
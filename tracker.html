<!-- <link rel="stylesheet" href="static/css/filtering-ui.css"> -->
<link rel="stylesheet" href="static/css/site.css">
<link rel="stylesheet" href="static/js/leaflet/leaflet.css" />
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="static/js/leaflet/leaflet.js"></script>
<script src="static/js/d3/d3.min.js"></script>


<style>
    .header>p>a {
        color: #2C9385;
    }

    #mapid {
        height: 400px;
    }

    .loading {
        text-align: center;
        margin: 275px 0px;
    }

    .loading>i {
        font-size: 40px;
        color: #2C9385;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        line-height: 18px;
        color: #555;
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    .vendor-image {
        /* display: block; */
        max-width: calc(100% - 10px);
        max-height: calc(100% - 10px);
        width: auto;
        height: auto;
        display: block;
        margin: 0 auto;
        vertical-align: middle;
    }

    .new-vendor {
        text-align: center;
        vertical-align: middle;
        padding: 5px;
        white-space: nowrap;
        display: flex;
        /*Uncomment below to center horizontally*/
        /*justify-content: center;*/
        align-items: center;
    }
</style>



<div class="header">
    <h1>RegTech<sup>2</sup>/SupTech Solution Tracker</h1>

    <div class="sqs-block image-block sqs-block-image sqs-text-ready" data-block-type="5" id="block-bb71bcf01551221b5acb">
        <div class="sqs-block-content" id="yui_3_17_2_1_1534208712486_120">
            <div class="image-block-outer-wrapper layout-caption-hidden design-layout-inline   " id="yui_3_17_2_1_1534208712486_119">
                <div class="intrinsic" style="max-width:2500.0px;" id="yui_3_17_2_1_1534208712486_118">
                    <div style="padding-bottom: 0.8%; overflow: hidden;" class="image-block-wrapper   has-aspect-ratio" data-description="" id="yui_3_17_2_1_1534208712486_117">
                        <noscript>
                            <img src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/" />
                        </noscript>
                        <img class="thumb-image loaded" data-src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image-dimensions="2500x20" data-image-focal-point="0.5,0.5" data-load="false" data-image-id="58ae0a57be659483ad503888"
                            data-type="image" data-position-mode="standard" src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/?format=1000w"
                            data-image-resolution="1000w" style="left: -2.30126%; top: 0%; width: 104.603%; height: 100%; position: absolute; noWrap: true;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p>This map will be updated to reflect RegTech solution around the world. Don't see your country's solution listed? Contact
        us at
        <a href="mailto:R2A@bfaglobal.com">R2A@bfaglobal.com</a>.</p>
</div>

<!-- <iframe width="100%" height="520" frameborder="0" src="https://bfaglobal.carto.com/u/bfglobal-admin/builder/c2a72170-bd93-436a-9fb2-067fd9706bcb/embed"
    allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe> -->

<div class="sqs-layout sqs-grid-12 columns-12 content">
    <div class="row sqs-row">
        <div class="col sqs-col-4 filtering-column">
            <div class="row sqs-row filtering-column-content">
                <div class="col sqs-col-12 filter-box vendors-header" data-step="0" style="padding-left:20px;">
                    <span class="vendors-number"></span> solutions
                </div>
                <div class="col sqs-col-12 filter-box" data-step="0">
                    <div class="col sqs-col-12 filter-title-box">
                        <div class="row sqs-row">
                            <span class="filter-title">
                                <i class="fa fa-angle-down m-r-sm angle"></i>
                                Category
                                <i class="fa fa-industry m-l-sm"></i>
                            </span>
                        </div>
                    </div>
                    <div class="col sqs-col-12 selected-filter selected-filter-0 hidden" data-step="0">
                        <i class="fa fa-filter"></i>
                        <i class="fa fa-times"></i>
                        <span></span>
                    </div>
                    <div class="col sqs-col-12 choices-box choices-step-0">
                    </div>
                </div>

                <div class="col sqs-col-12 span-12 filter-box" data-step="1">
                    <div class="col sqs-col-12 filter-title-box">
                        <span class="filter-title">
                            <i class="fa fa-angle-right m-r-sm angle"></i>
                            Use case
                            <i class="fa fa-list m-l-sm"></i>
                        </span>
                    </div>
                    <div class="col sqs-col-12 selected-filter selected-filter-1 hidden" data-step="1">
                        <i class="fa fa-filter"></i>
                        <i class="fa fa-times"></i>
                        <span></span>
                    </div>
                    <div class="col sqs-col-12 choices-box choices-step-1 hidden" data-step="1">
                    </div>
                </div>

                <div class="col sqs-col-12 span-12 filter-box" data-step="2">
                    <div class="col sqs-col-12 filter-title-box">
                        <span class="filter-title">
                            <i class="fa fa-angle-right m-r-sm angle"></i>
                            Technology
                            <i class="fa fa-cogs m-l-sm"></i>
                        </span>
                    </div>
                    <div class="col sqs-col-12 selected-filter selected-filter-2 hidden" data-step="2">
                        <i class="fa fa-filter"></i>
                        <i class="fa fa-times"></i>
                        <span></span>
                    </div>
                    <div class="col sqs-col-12 choices-box choices-step-2 hidden">
                    </div>
                </div>

                <div class="col sqs-col-12 span-12 filter-box" data-step="3">
                    <div class="col sqs-col-12 filter-title-box">
                        <span class="filter-title">
                            <i class="fa fa-angle-right m-r-sm angle"></i>
                            Location availability
                            <i class="fa fa-map m-l-sm"></i>
                        </span>
                    </div>
                    <div class="col sqs-col-12 selected-filter selected-filter-3 hidden" data-step="3">
                        <i class="fa fa-filter"></i>
                        <i class="fa fa-times"></i>
                        <span></span>
                    </div>
                    <div class="col sqs-col-12 choices-box choices-step-3 hidden">
                    </div>
                </div>
            </div>
        </div>

        <div class="col sqs-col-8">


            <div id="contents">
                <div class="loading">
                    <h4>Loading...</h4>
                    <i class="fas fa-circle-notch fa-spin"></i>
                </div>
            </div>


            <div class="deployment-list">
            </div>

            <!-- <div class="sqs-block button-block sqs-block-button" data-block-type="53" id="block-yui_3_17_2_1_1524083958927_9987" style="padding-top: 20px;">
                    <div class="sqs-block-content" id="yui_3_17_2_1_1534259152465_183">
                        <div class="sqs-block-button-container--center" data-alignment="center" data-button-size="medium" id="yui_3_17_2_1_1534259152465_182">
                            <a href="https://docs.google.com/forms/d/e/1FAIpQLSc4srjLTgwozGTdQbWDyH6BHTFWpO7YREbJ8qu8Am6JrEWl4Q/viewform" class="sqs-block-button-element--medium sqs-block-button-element"
                                data-initialized="true" target="_blank" id="yui_3_17_2_1_1534259152465_387">Don't see your solution listed? Let us know.</a>
                        </div>
                    </div>
                </div> -->
        </div>
    </div>


</div>


<script>

    // setTimeout(function () { //Simulate loading conditions
    var categories = ['Exploratory', 'Developmental', 'Operational']


    Promise.all([
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTYPKjQhh6VuHPB0fezf1fOH4s90BSbrVNjYP5QHGAwtJTeYmB1vGxrZQHKtkgHlNxAsdITJu5g5J6p/pub?gid=553555379&single=true&output=csv"),
        d3.json("./static/js/leaflet/countries.json")
    ]).then((data) => {

        var contents = document.getElementById('contents');
        contents.innerHTML = '<div id="mapid"></div>'
        var map = L.map('mapid', {
            zoomSnap: 0.05
        });

        // create the tile layer with correct attribution
        var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, { minZoom: 1, maxZoom: 4, attribution: osmAttrib });

        // start the map in South-East England
        var initialZoom = 2.25
        map.setView(new L.LatLng(25.307577, 1.743395), initialZoom);
        map.fitBounds([
            [66.263456, -177.891759],
            [-27.816707, 144.109652],
            [62.613873, 178.533777]
        ])
        map.addLayer(osm);



        const deployments = data[0]
        const countryShapes = data[1]['features']

        console.log(countryShapes)
        const mapData = deployments.reduce((acc, deployment) => {
            deployment.Country = deployment.Country.trim()

            var countryShape = countryShapes.filter(shape => {
                return shape.properties.country_name === deployment.Country |
                    (shape.properties.alternative_names.indexOf(deployment.Country) !== -1)
            })[0]

            if (countryShape !== undefined) {
                var foundShapeDeployment = acc.filter(shapeDeployments => {
                    return shapeDeployments.properties.country_name === countryShape.properties.country_name
                })[0]
                if (foundShapeDeployment !== undefined) {
                    foundShapeDeployment.properties.deployments.push(deployment)
                } else {
                    countryShape.properties.deployments = [deployment];
                    acc.push(countryShape)
                }
            } else { console.warn("Could Not Find Shape for Country", deployment.Country) }

            return acc
        }, []);

        console.log("Map Data", mapData)

        var geojson;
        geojson = L.geoJson(mapData, { style: style }).addTo(map);

        function getColor(d) {
            return d >= 2 ? '#1b988a' :
                d >= 1 ? '#16716a' :
                    '#104949';
        }

        function highestIndexOfDeplyments(deployments) {
            var found = -1
            categories.slice().reverse().forEach((cat, idx) => {
                if (deployments.filter(e => { return e.Status.trim() === categories[idx] }).length > 0) {
                    found = idx
                }
            })
            return found
        }

        function style(feature) {
            var color = getColor(highestIndexOfDeplyments(feature.properties.deployments))
            return {
                fillColor: color,
                fillOpacity: 0.5,
                weight: 2,
                opacity: .5,
                color: color,
                // dashArray: 3,
            };
        }

        // function highlightFeature(e) {
        //     var color = getColor(highestIndexOfDeplyments(e.target.feature.properties.deployments))
        //     var layer = e.target;

        //     layer.setStyle({
        //         // weight: 5,
        //         color: color,
        //         dashArray: '',
        //         opacity: 1,
        //         fillOpacity: 0.7
        //     });

        //     if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        //         layer.bringToFront();
        //     }

        //     info.update(layer.feature.properties);
        // }

        // function resetHighlight(e) {
        //     geojson.resetStyle(e.target);
        //     info.update();
        // }

        function selectedCountry(e) {
            console.log(e.target)
            showDeployments(e.target.feature.properties.deployments)
            zoomToFeature(e)
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                // mouseover: highlightFeature,
                // mouseout: resetHighlight,
                click: selectedCountry
            });
        }

        geojson = L.geoJson(mapData, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);

        // var filter = L.control({ position: 'topleft' })
        // filter.onAdd = function (map) {
        //     this._div = L.DomUtil.create('div', 'sqs-block-content'); // create a div with a class "info"
        //     this._div.innerHTML = `
        //     <div class="sqs-block button-block sqs-block-button" data-block-type="53" id="block-yui_3_17_2_1_1524083958927_9987" style="padding-top: 0px;">
        //         <div class="sqs-block-content" id="yui_3_17_2_1_1534259152465_183">
        //             <div class="sqs-block-button-container--center" data-alignment="center" data-button-size="small" id="yui_3_17_2_1_1534259152465_182">
        //                 <a href="" class="sqs-block-button-element--small sqs-block-button-element" data-initialized="true" target="_blank" id="yui_3_17_2_1_1534259152465_387">Filter</a>
        //             </div>
        //         </div>
        //     </div>            `
        //     return this._div;
        // }
        // filter.addTo(map)

        // Hover over

        // var info = L.control();

        // info.onAdd = function (map) {
        //     this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
        //     this.update();
        //     return this._div;
        // };

        // // method that we will use to update the control based on feature properties passed
        // info.update = function (properties) {
        //     var infoText = ""
        //     if (properties) {
        //         infoText += '<b>' + properties.country_name + '</b><br />' + properties.deployments.length + ' use cases:<p><ul>'
        //         properties.deployments.forEach(deployment => {
        //             infoText += "<li>" + deployment["Use case"].trunc(30) + "</li>"
        //         })
        //         infoText += "</ul>"

        //     } else {
        //         infoText = 'Hover over a country'
        //     }
        //     this._div.innerHTML = infoText
        // };

        // info.addTo(map);

        // Legend

        var legend = L.control({ position: 'topright' });

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                labels = [];

            // div.innerHTML += '<h4>Deployments</h4>'
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < categories.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(i) + '"></i> ' + categories[i] + '<br>';
            }

            return div;
        };

        legend.addTo(map);

        String.prototype.trunc =
            function (n) {
                return this.substr(0, n - 1) + (this.length > n ? '&hellip;' : '');
            };

        map.invalidateSize()

        jQuery(document).bind('leaflet.map', function (event, map, lMap) {
            lMap.zoomControl.setPosition('bottomleft');
        });

        function showDeployments(deploymentsToShow) {
            console.log(deploymentsToShow);

            var deployments = d3.nest()
                .key(function (d) { return d.Agency; })
                .entries(deploymentsToShow);

            console.log(deployments);

            var targetElement = $(".deployment-list");
            targetElement.html("");
            if (!deployments.length) {
                console.log("no deployments to show");
                var noVendorsMessage = '<p class="no-vendors-message">There are no deployments available with the active filters.<br />\
        Review current filters on the left-hand side.</p>';
                targetElement.append(noVendorsMessage);
            }

            deployments.forEach(deployment => {
                console.log(deployment);

                targetElement.append($(`
                    <div class="new-vendor" data-vendor-id="1` + deployment.key + `">

                        <img class="vendor-image" src="` + deployment.values[0]["Image"] + `" />
                    </div>`
                ));
            })
        }
    })
    // }, 3000);



</script>
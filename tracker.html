<!-- <link rel="stylesheet" href="static/css/filtering-ui.css"> -->
<link rel="stylesheet" href="static/css/site.css">
<link rel="stylesheet" href="static/js/leaflet/leaflet.css" />
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="static/js/leaflet/leaflet.js"></script>
<script src="static/js/d3/d3.min.js"></script>


<style>
    .header>p>a {
        color: #2C9385;
    }

    #mapid {
        height: 400px;
    }

    .loading {
        text-align: center;
        margin: 125px 0px;
    }

    .loading>i {
        font-size: 40px;
        color: #2C9385;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        line-height: 18px;
        color: #555;
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    .vendor-image {
        /* display: block; */
        max-width: calc(100% - 10px);
        max-height: calc(100% - 10px);
        width: auto;
        height: auto;
        display: block;
        margin: 0 auto;
        vertical-align: middle;
    }

    .new-vendor {
        text-align: center;
        vertical-align: middle;
        padding: 5px;
        white-space: nowrap;
        display: flex;
        /*Uncomment below to center horizontally*/
        /*justify-content: center;*/
        align-items: center;
        width:29%;
    }

    .uk-accordion-title,
    .uk-accordion-title:focus,
    .uk-accordion-title:hover,
    .uk-accordion-title::after {
        font-size: 1.2em;
        font-weight: 400;
        color: #00a69c;
        fill: #00a69c;
    }

    a.uk-accordion-title>i {
        margin: 0px 10px;
    }

    /* ul>li {
        border-color: #0a2d37;
        border-width: 2px;
        border-style: solid;
        padding: 20px;
    } */
    .filter {
        border-color: #0a2d37;
        color: #0a2d37;
        border-width: 2px;
        border-style: solid;
        padding: 10px;
        margin: 10px 5px 10px 0px;
        display: inline-block;
    }

    .filter>.fa-times {
        color: #0a2d37;
        margin-left: 5px;
    }

    .filtering-column>ul {
        margin: 0px 10px 0px 24px;
    }

    ul>li>div {
        margin-left: 10px;
    }

    .uk-badge {
        background-color: #00a69c;
        margin: 0px 10px;
    }

    .sqs-layout>.sqs-row {
        margin-left: 0px;
        margin-right: 0px;
    }
</style>



<div class="header">
    <h1>RegTech<sup>2</sup>/SupTech Solution Tracker</h1>

    <div class="sqs-block image-block sqs-block-image sqs-text-ready" data-block-type="5" id="block-bb71bcf01551221b5acb">
        <div class="sqs-block-content" id="yui_3_17_2_1_1534208712486_120">
            <div class="image-block-outer-wrapper layout-caption-hidden design-layout-inline   " id="yui_3_17_2_1_1534208712486_119">
                <div class="intrinsic" style="max-width:2500.0px;" id="yui_3_17_2_1_1534208712486_118">
                    <div style="padding-bottom: 0.8%; overflow: hidden;" class="image-block-wrapper   has-aspect-ratio" data-description="" id="yui_3_17_2_1_1534208712486_117">
                        <noscript>
                            <img src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/" />
                        </noscript>
                        <img class="thumb-image loaded" data-src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image-dimensions="2500x20" data-image-focal-point="0.5,0.5" data-load="false" data-image-id="58ae0a57be659483ad503888"
                            data-type="image" data-position-mode="standard" src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/?format=1000w"
                            data-image-resolution="1000w" style="left: -2.30126%; top: 0%; width: 104.603%; height: 100%; position: absolute; noWrap: true;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p>This map will be updated to reflect RegTech solution around the world. Don't see your country's solution listed? Contact
        us at
        <a href="mailto:R2A@bfaglobal.com">R2A@bfaglobal.com</a>.</p>
</div>


<!-- <div class="sqs-layout sqs-grid-12 columns-12" style="margin:20px 0px;">
    <div class="row sqs-row">
        <div class="col sqs-col-4">
        </div>
    </div>
</div> -->


<div class="sqs-layout sqs-grid-12 columns-12 content">
    <div class="row sqs-row">
        <div class="col sqs-col-4 filtering-column">

            <div style="margin:10px 0px 20px 24px">
                <span id="solutions-number"></span> solutions
            </div>


            <ul id="filters" uk-accordion="multiple: false">
                <li>
                    <a class="uk-accordion-title" href="#">
                        Use Cases
                        <i class="fa fa-list m-l-sm"></i>
                    </a>
                    <div id='use-case-choices' class="uk-accordion-content"> </div>
                </li>
                <li>
                    <a class="uk-accordion-title" href="#">
                        Technology
                        <i class="fa fa-cogs m-l-sm"></i>
                    </a>
                    <div class="uk-accordion-content">
                        <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
                            consequat. Duis aute irure dolor reprehenderit.</p>
                    </div>
                </li>
                <li>
                    <a class="uk-accordion-title" href="#">
                        Location
                        <i class="fa fa-map m-l-sm"></i>
                    </a>
                    <div class="uk-accordion-content">
                        <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                            Excepteur sint occaecat cupidatat proident.</p>
                    </div>
                </li>
            </ul>
        </div>

        <div class="col sqs-col-8">

            <div id="contents">
                <div class="loading">
                    <h4>Loading...</h4>
                    <i class="fas fa-circle-notch fa-spin"></i>
                </div>
            </div>

            <div id="selected-filter"> </div>
            <div class="deployment-list"> </div>
        </div>
    </div>

</div>


<script src="./static/js/map-utils.js"></script>
<script src="./static/js/data-formatter.js"></script>
<script src="./static/js/accordian.js"></script>
<script>

    // setTimeout(function () { //Simulate loading conditions
    var categories = ['Exploratory', 'Developmental', 'Operational']
    var allCountryShapes = []

    var allDeployments = [];
    var mapData = []

    var selectedDeployments = [];

    var filterOptions = {
        useCases: [],
        tech: [],
        locations: [],
    }

    var selectedFilters = {
        useCases: [],
        tech: [],
        locations: [],
    }

    var mapConfig = {
        containerElementId: 'contents',
        mapId: 'mapid',
        osmUrl: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        zoomSnap: 0.05,
        minZoom: 1,
        maxZoom: 4,
        mapStyle: 'margin-right: 15px;',
        latLonBounds: [
            [66.263456, -177.891759],
            [-27.816707, 144.109652],
            [62.613873, 178.533777]
        ]
    }


    Promise.all([
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTYPKjQhh6VuHPB0fezf1fOH4s90BSbrVNjYP5QHGAwtJTeYmB1vGxrZQHKtkgHlNxAsdITJu5g5J6p/pub?gid=553555379&single=true&output=csv"),
        d3.json("./static/js/leaflet/countries.json")
    ]).then((data) => {

        // Format Data
        formatData(data)

        // Display Formatted Data

        updateSelectedDeployments()

        // setTimeout(()=>{
        //     UIkit.accordion('#filters').toggle(0, true);
        // }, 1500)

        var map = createMap(mapConfig)
        var geojson = L.geoJson(mapData, { style: style }).addTo(map);

        function getColor(d) {
            return d >= 2 ? '#1b988a' :
                d >= 1 ? '#16716a' :
                    '#104949';
        }

        function highestIndexOfDeplyments(deployments) {
            var found = -1
            categories.slice().reverse().forEach((cat, idx) => {
                if (deployments.filter(e => { return e.Status.trim() === categories[idx] }).length > 0) {
                    found = idx
                }
            })
            return found
        }

        function style(feature) {
            var color = getColor(highestIndexOfDeplyments(feature.properties.deployments))
            return {
                fillColor: color,
                fillOpacity: 0.5,
                weight: 2,
                opacity: .5,
                color: color,
                // dashArray: 3,
            };
        }

        function selectedCountry(e) {
            console.log(e.target)
            showDeployments(e.target.feature.properties.deployments)
            zoomToFeature(e)
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                // mouseover: highlightFeature,
                // mouseout: resetHighlight,
                click: selectedCountry
            });
        }

        geojson = L.geoJson(mapData, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);


        // Legend

        var legend = L.control({ position: 'topright' });

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                labels = [];

            // div.innerHTML += '<h4>Deployments</h4>'
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < categories.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(i) + '"></i> ' + categories[i] + '<br>';
            }

            return div;
        };

        legend.addTo(map);

        String.prototype.trunc =
            function (n) {
                return this.substr(0, n - 1) + (this.length > n ? '&hellip;' : '');
            };

        map.invalidateSize()

        jQuery(document).bind('leaflet.map', function (event, map, lMap) {
            lMap.zoomControl.setPosition('bottomleft');
        });

    })
    // }, 3000);
    function showDeployments(deploymentsToShow) {
        console.log(deploymentsToShow);

        var deployments = d3.nest()
            .key(function (d) { return d.Agency; })
            .entries(deploymentsToShow);

        console.log(deployments);

        var targetElement = $(".deployment-list");
        targetElement.html("");
        if (!deployments.length) {
            console.log("no deployments to show");
            var noVendorsMessage = '<p class="no-vendors-message">There are no deployments available with the active filters.<br />\
        Review current filters on the left-hand side.</p>';
            targetElement.append(noVendorsMessage);
        }

        deployments.forEach(deployment => {
            console.log(deployment);

            targetElement.append($(`
                    <div class="new-vendor" data-vendor-id="1` + deployment.key + `">

                        <img class="vendor-image" src="` + deployment.values[0]["Image"] + `" />
                    </div>`
            ));
        })
    }

    function addFilter(key, value) {
        selectedFilters[key].push(value);
        updateFilterBarList()
        updateSelectedDeployments()
    }

    function updateFilterBarList() {

        $('#selected-filter').empty()
        var filterHTML = ''
        Object.keys(selectedFilters).forEach(filterKey => {
            var filters = selectedFilters[filterKey]
            console.log(filters);
            filters.forEach(filter => {
                filterHTML += '<div class="filter">' + filter + ' <i class="fa fa-times" aria-hidden="true"></i></div>'
            });
        });
        $('#selected-filter').html(filterHTML)

        $('.filter').click((event) => {
            removeFilter(event.target.innerText)
        })
    }

    function removeFilter(value) {
        removeSelectedFilter(value)
        updateFilterBarList()
        updateSelectedDeployments()
    }

    function removeSelectedFilter(value) {
        Object.keys(selectedFilters).forEach(filterKey => {
            var index = selectedFilters[filterKey].indexOf(value.trim())
            if (index !== -1) {
                selectedFilters[filterKey].splice(index, 1)
            }
        });
    }

    function updateSelectedDeployments() {
        selectedDeployments = deploymentsMatchingFilters(allDeployments, selectedFilters)
        $('#solutions-number').html(selectedDeployments.length)

        updateAccordianFilters()
        showDeployments(selectedDeployments)
        // Update Map Here!
    }

    function updateAccordianFilters() {

        remainingUseCases = uniqueProperties(selectedDeployments, 'useCases').sort();
        selectedFilters.useCases.forEach(useCase => {
            console.log("remainig", remainingUseCases)
            index = remainingUseCases.indexOf(useCase)
            if (index !== -1) {
                console.log("removing", useCase)
                remainingUseCases.splice(index, 1)
            }
        })
        console.log("remainig", remainingUseCases)

        displayAccordianValues(remainingUseCases, {
            elementId: '#use-case-choices',
            selected: (event => {
                $('.uk-badge').remove()
                addFilter('useCases', event.target.innerText)
            }),
            mouseover: (event => {
                // console.log("Badge Count", event.target.innerText)
                copiedFilters = jQuery.extend(true, {}, selectedFilters);
                copiedFilters['useCases'].push(event.target.innerText)
                matched = deploymentsMatchingFilters(selectedDeployments, copiedFilters)
                $(event.target).append('<span class="uk-badge">' + matched.length + '</span>')
            }),
            mouseout: (event => {
                $('.uk-badge').remove()
            }),
            emptyText: "All options selected"
        })

    }

    function deploymentsMatchingFilters(deployments, matchFilters) {
        var matchedDeployments = [];

        deployments.forEach(deployment => {
            var matchesAllFilters = true;
            Object.keys(matchFilters).forEach(filterKey => {
                var filters = matchFilters[filterKey]
                if (filterKey === 'useCases') {
                    filters.forEach(filter => {
                        if (deployment.useCases.indexOf(filter) === -1) {
                            matchesAllFilters = false
                        }
                    })
                }

            })
            if (matchesAllFilters) {
                matchedDeployments.push(deployment)
            }
        })

        return matchedDeployments
    }

    function formatData(data) {
        allDeployments = data[0]
        allDeployments.forEach((dataEl) => {
            const useCasePropName = 'Use case'
            if (useCasePropName in dataEl) {
                dataEl.useCases = dataEl[useCasePropName].split(';').map(el => {
                    return el.trim()
                })
            }
        })
        console.log('allDeployments', allDeployments)

        allCountryShapes = data[1]['features']
        console.log('allCountryShapes', allCountryShapes)

        filterOptions.useCases = uniqueProperties(allDeployments, 'useCases').sort()
        console.log('filterOptions.useCases', filterOptions.useCases)

        mapData = allDeployments.reduce((acc, deployment) => {
            deployment.Country = deployment.Country.trim()

            var countryShape = allCountryShapes.filter(shape => {
                return shape.properties.country_name === deployment.Country |
                    (shape.properties.alternative_names.indexOf(deployment.Country) !== -1)
            })[0]

            if (countryShape !== undefined) {
                var foundShapeDeployment = acc.filter(shapeDeployments => {
                    return shapeDeployments.properties.country_name === countryShape.properties.country_name
                })[0]
                if (foundShapeDeployment !== undefined) {
                    foundShapeDeployment.properties.deployments.push(deployment)
                } else {
                    countryShape.properties.deployments = [deployment];
                    acc.push(countryShape)
                }
            } else { console.warn("Could Not Find Shape for Country", deployment.Country) }

            return acc
        }, []);

        console.log("Map Data", mapData)
    }

</script>
<!-- <link rel="stylesheet" href="static/css/filtering-ui.css"> -->
<link rel="stylesheet" href="static/js/leaflet/leaflet.css" />
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="static/js/leaflet/leaflet.js"></script>


<style>
    #mapid {
        height: 400px;
    }

    .jBox-content>p {
        margin-top: 5px;
        margin-bottom: 5px;
    }

    .solution {
        margin-left: 20px;
    }

    .solution>p {
        margin: 5px 0px;
    }

    .reset-filters {
        margin: 0px 5px 10px 0px;
        display: inline-block;
    }

    .search-input {
        color: #0a2d37;
        transition: background-image .2s ease-out;
        padding: 12px 12px 12px 45px;
        background: url(/static/images/icon-search.png) no-repeat 15px 50%;
        width: calc(100% - 60px);
        min-height: 20px;
        display: block;
        outline: 0;
        box-sizing: border-box;
    }

    .error {
        margin: 125px 0px;
        text-align: center;
        display: none;
    }

    .fa-exclamation-triangle {
        font-size: 4em;
        color: #2C9385;
    }

    .autocomplete {
        margin: 0 24px;
        margin-bottom: 24px;
    }

    .footer > p {
        text-align: center;
    } 

    a {
        color: #2C9385;
    }

    .sqs-block-horizontalrule {
        margin-top: 60px;
    }
</style>



<div class="header">
    <h1>RegTech<sup>2</sup>/SupTech Solution Tracker</h1>

    <div class="sqs-block image-block sqs-block-image sqs-text-ready" data-block-type="5" id="block-bb71bcf01551221b5acb">
        <div class="sqs-block-content" id="yui_3_17_2_1_1534208712486_120">
            <div class="image-block-outer-wrapper layout-caption-hidden design-layout-inline   " id="yui_3_17_2_1_1534208712486_119">
                <div class="intrinsic" style="max-width:2500.0px;" id="yui_3_17_2_1_1534208712486_118">
                    <div style="padding-bottom: 0.8%; overflow: hidden;" class="image-block-wrapper   has-aspect-ratio"
                        data-description="" id="yui_3_17_2_1_1534208712486_117">
                        <noscript>
                            <img src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/" />
                        </noscript>
                        <img class="thumb-image loaded" data-src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/"
                            data-image-dimensions="2500x20" data-image-focal-point="0.5,0.5" data-load="false"
                            data-image-id="58ae0a57be659483ad503888" data-type="image" data-position-mode="standard"
                            src="https://static1.squarespace.com/static/583ddaade4fcb5082fec58f4/t/58ae0a57be659483ad503888/1481310406265/?format=1000w"
                            data-image-resolution="1000w" style="left: -2.30126%; top: 0%; width: 104.603%; height: 100%; position: absolute; noWrap: true;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p>This map will be updated to reflect RegTech solutions around the world. Don't see your country's solution
        listed?
        Contact us at
        <a href="mailto:R2A@bfaglobal.com">R2A@bfaglobal.com</a>.</p>
</div>

<div class="loading">
    <h4>Loading...</h4>
    <i class="fas fa-circle-notch fa-spin"></i>
</div>

<div class="error">
    <i class="fas fa-exclamation-triangle"></i>
    <h4>Uh oh. An error has occurred.</h4>
    <p>Please refresh or try again later. You can also contact <a href="mailto:R2A@bfaglobal.com">R2A@bfaglobal.com</a>.</p>
    </p>
</div>

<div id="solutions-tracker" class="sqs-layout sqs-grid-12 columns-12 content" style="display:none; margin-top: 30px;">
    <div class="row sqs-row">
        <div class="col sqs-col-4 accordian-selections">

            <div class="autocomplete">
                <input id="search-box" type="search" class="search-input dark-border" value="" placeholder="Search">
            </div>

            <ul id="filters" uk-accordion="multiple: true">
                <li>
                    <span class="uk-accordion-title">
                        Use Cases
                        <i class="fa fa-list m-l-sm"></i>
                    </span>
                    <div id='useCases-choices' class="uk-accordion-content"> </div>
                </li>
                <li>
                    <span class="uk-accordion-title">
                        Technology
                        <i class="fa fa-cogs m-l-sm"></i>
                    </span>
                    <div id='tech-choices' class="uk-accordion-content"> </div>
                </li>
                <li>
                    <span class="uk-accordion-title">
                        Status
                        <i class="fa fa-check-circle m-l-sm"></i>
                    </span>
                    <div id='status-choices' class="uk-accordion-content"> </div>
                </li>
                <li>
                    <span class="uk-accordion-title">
                        Location
                        <i class="fa fa-map m-l-sm"></i>
                    </span>
                    <div id='locations-choices' class="uk-accordion-content"> </div>
                </li>
            </ul>
        </div>

        <div class="col sqs-col-8">

            <div class="row sqs-row">
                <div id="map"></div>
            </div>

            <div id="selected-filter" class="row sqs-row" style="margin-bottom: 24px"> </div>

            <div class="row sqs-row">
                <div class="col sqs-col-6">
                    <div class="reset-filters dark-border dark-button">Reset Filters</div>
                    <span style="display:inline-block;">&nbsp;</span>
                </div>
                <div class="col sqs-col-2">
                    <div class="solutions-number-container">
                        <span id="solutions-number"></span>
                    </div>
                </div>
            </div>

            <div id="deployment-list" class="row sqs-row tile-grid"></div>

        </div>
    </div>

    <div class="footer">
        <div class="sqs-block horizontalrule-block sqs-block-horizontalrule" data-block-type="47" id="block-yui_3_17_2_17_1485376301511_24615">
            <div class="sqs-block-content">
                <hr>
            </div>
        </div>
        <p>Maps provided by <a href="http://leafletjs.com/">Leaflet</a> and Â© <a href="https://openstreetmap.org">OpenStreetMap</a>
            contributors</p>
    </div>


</div>

<script src="./static/js/data-formatter.js"></script>

<script src="./static/components/map/map.js"></script>
<link rel="stylesheet" href="static/components/map/map.css">

<script src="./static/components/accordian/accordian.js"></script>
<link rel="stylesheet" href="static/components/accordian/accordian.css">

<script src="./static/components/autocomplete/autocomplete.js"></script>
<link rel="stylesheet" href="static/components/autocomplete/autocomplete.css">

<script src="./static/components/filterbar/filterbar.js"></script>
<link rel="stylesheet" href="static/components/filterbar/filterbar.css">

<script src="./static/components/tile-grid/tile-grid.js"></script>
<link rel="stylesheet" href="static/components/tile-grid/tile-grid.css">

<script>

    $(".tracker").addClass("active")


    var categories = ['Exploratory', 'Developmental', 'Operational']
    var filterGroups = ['useCases', 'tech', 'status', 'locations']
    var allCountryShapes = []

    var allDeployments = [];
    var groupedSolutions = {}

    var selectedDeployments = [];

    var filterOptions = {
        useCases: [],
        tech: [],
        status: [],
        locations: [],
        abrev: [],
        names: [],
    }

    var selectedFilters = {
        useCases: [],
        tech: [],
        status: [],
        locations: [],
        abrev: [],
        names: [],
    }

    var getColor = (d) => {
        return d >= 2 ? '#1b988a' :
            d >= 1 ? '#16716a' :
                '#104949';
    }

    var getStyle = (feature) => {
        var color = getColor(indexFromFeature(feature))
        return {
            fillColor: color,
            fillOpacity: 0.8,
            weight: 2,
            opacity: .8,
            color: color,
        }
    }

    var indexFromFeature = (feature) => {
        var found = -1
        categories.slice().reverse().forEach((cat, idx) => {
            if (feature.properties.deployments.filter(e => { return e.Status.trim() === categories[idx] }).length > 0) {
                found = idx
            }
        })
        return found
    }

    var mapConfig = {
        containerElementId: 'map',
        mapId: 'mapid',
        osmUrl: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        attributionControl: false,
        zoomSnap: 0.05,
        minZoom: 1,
        maxZoom: 7,
        mapStyle: 'margin:0px 0px 10px 0px;',
        getColor: getColor,
        getStyle: getStyle,
        getHighlightStyle: {
            weight: 3,
            dashArray: '',
            fillOpacity: 1.0
        },
        indexFromFeature: indexFromFeature,
        selection: (e) => {
            var country = e.target.feature.properties.country_name
            if (selectedFilters.locations.indexOf(country) === -1) {
                selectedFilters.locations = []
                customGA('send', 'event', 'Solution Filter: ' + 'locations', 'add', country);
                addFilter('locations', country, updateUI)
            }
        }
    }

    var modal

    Promise.all([
        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTYPKjQhh6VuHPB0fezf1fOH4s90BSbrVNjYP5QHGAwtJTeYmB1vGxrZQHKtkgHlNxAsdITJu5g5J6p/pub?gid=553555379&single=true&output=csv"),
        d3.json("./static/js/leaflet/countries.json")
    ]).then((data) => {

        console.log(data)
        // Format Data
        formatData(data)

        // Setup Map
        map = createMap(mapConfig)
        createLegend({ position: 'topright' }, categories).addTo(map);
        mapOverlay = createOverlay({
            position: 'bottomleft',
            hoverOnly: true,
            innerHTML: 'Select to filter by country',
        }).addTo(map);

        map.invalidateSize()

        // Hide Loading & Show Tracker
        $(".loading").css("display", "none")
        $("#solutions-tracker").css("display", "block")

        // Set the UI
        autocomplete(
            document.getElementById("search-box"),
            Object.keys(filterOptions).reduce((acc, filterKey) => {
                return acc.concat(filterOptions[filterKey])
            }, []).sort(), selected => {
                $("#search-box").val("")
                key = findFilterKeyForValue(filterOptions, selected)
                removeAllFilters()
                customGA('send', 'event', 'Solution Search: ' + key, 'remove', selected);
                addFilter(key, selected, updateUI)
                unfoldFilterGroup(key)
            });

        updateUI()

        setTimeout(() => {
            unfoldFilterGroup('useCases')
        }, 1000)
    })
        .catch(error => {
            if (error) {
                console.error("Caught Error:", error)
                $(".loading").css("display", "none")
                $(".error").css("display", "block")
            }
        })


    // UI Updates 
    function updateUI() {
        selectedDeployments = deploymentsMatchingFilters(allDeployments, selectedFilters)
        $('#solutions-number').html(selectedDeployments.length + ' solution' + (selectedDeployments.length !== 1 ? 's' : ''))
        updateResetButtonVisibility()
        updateSelectedFiltersUI('#selected-filter', selectedFilters, (event) => {
            filterValue = event.currentTarget.innerText
            customGA('send', 'event', 'Solution Filter: ' + findFilterKeyForValue(filterOptions, filterValue), 'remove', filterValue);
            removeFilter(filterValue, updateUI)
        })
        updateDeploymentTiles()
        updateAccordianFilters()
        updateMap(mapFormattedDeployments(deploymentsMatchingFilters(allDeployments, selectedFilters, true)))
    }

    function updateResetButtonVisibility() {
        style = (filterCount(selectedFilters) ? 'inline-block' : 'none')
        $(".reset-filters").css('display', style)
    }

    $('.reset-filters').click(event => {
        customGA('send', 'event', 'Solution Filter', 'reset', '');
        removeAllFilters(updateUI)
    })

    function updateDeploymentTiles() {
        updateTileGrid(
            "#deployment-list",
            d3.nest()
                .key(function (d) { return d.Agency; })
                .entries(selectedDeployments)
            , {
                emptyText: "There are no solutions available with the selected filters.<br />Review current filters on the left-hand side. ",
                idMap: (el) => { return el.key },
                tileContent: (el) => {
                    return `<img class="tile-image" src="` + el.values[0]["Image"] + `" />`
                },
                tileSelected: (id) => {
                    displayDeployment(id)
                }
            })
    }


    function updateAccordianFilters() {
        displayAccordianOptions('useCases', selectedFilters.useCases)
        displayAccordianOptions('technology', selectedFilters.tech, 'tech')
        displayAccordianOptions('Status', selectedFilters.status, 'status')
        displayAccordianOptions('Country', selectedFilters.locations, 'locations')
    }

    function displayAccordianOptions(filterOptionKey, selections, id) {
        if (!id) id = filterOptionKey
        displayAccordianValues(filteredFilters(filterOptionKey, selections), selections, accordianConfigForFilterKey(id))
    }

    // Data Formatters
    function filteredFilters(key, selections) {
        remainingFilters = uniqueProperties(selectedDeployments, key).sort();
        selections.forEach(filter => {
            index = remainingFilters.indexOf(filter)
            if (index !== -1) {
                remainingFilters.splice(index, 1)
            }
        })
        return remainingFilters
    }

    function accordianConfigForFilterKey(key) {
        return {
            elementId: '#' + key + '-choices',
            selected: accordianSelectionForFilterType(key),
            deselected: accordianDeselectionForFilterType(key),
            mouseover: accordianMouseoverForFilterType(key),
            mouseout: event => { $('.badge-count').remove() },
            emptyText: "All options selected"
        }
    }

    function accordianSelectionForFilterType(filterType) {
        return (event) => {
            $('.badge-count').remove()
            filterValue = event.currentTarget.innerText
            customGA('send', 'event', 'Solution Filter: ' + filterType, 'add', filterValue);
            addFilter(filterType, filterValue, updateUI)
            unfoldFilterGroup(filterType, true);
        }
    }

    function unfoldFilterGroup(groupName, next) {
        index = filterGroups.indexOf(groupName)
        if (index != -1) {
            if (next) { index += 1 }
            if (index < filterGroups.length && filterGroupIsClosed(index)) {
                UIkit.accordion('#filters').toggle(index, true);
            }
        }
    }

    function filterGroupIsClosed(index) {
        var attr = $('ul.uk-accordion>li:nth-child(' + (index + 1) + ")>div").attr('hidden')
        return typeof attr !== typeof undefined && attr !== false
    }


    function accordianDeselectionForFilterType(filterType) {
        return (event) => {
            $('.badge-count').remove()
            filterValue = event.currentTarget.innerText
            console.log(filterValue)
            customGA('send', 'event', 'Solution Filter: ' + findFilterKeyForValue(filterOptions, filterValue), 'remove', filterValue);
            removeFilter(filterValue, updateUI)
        }
    }

    function accordianMouseoverForFilterType(filterType) {
        return (event) => {
            copiedFilters = jQuery.extend(true, {}, selectedFilters);
            copiedFilters[filterType].push(event.target.innerText)
            matched = deploymentsMatchingFilters(selectedDeployments, copiedFilters)
            $(event.target).append('<span class="uk-badge badge-count">' + matched.length + '</span>')
        }
    }

    function deploymentsMatchingFilters(deployments, matchFilters, ignoreLocation) {
        var matchedDeployments = [];

        deployments.forEach(deployment => {
            var matchesAllFilters = true;
            Object.keys(matchFilters).forEach(filterKey => {
                var filters = matchFilters[filterKey]
                if (filterKey === 'useCases') {
                    filters.forEach(filter => {
                        if (deployment.useCases.indexOf(filter) === -1) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'tech') {
                    filters.forEach(filter => {
                        if (deployment.technology.indexOf(filter) === -1) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'status') {
                    filters.forEach(filter => {
                        if (filter !== deployment.Status.trim()) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'locations' && !ignoreLocation) {
                    filters.forEach(filter => {
                        if (filter !== deployment.Country.trim()) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'names') {
                    filters.forEach(filter => {
                        if (deployment['Agency Full Name'].trim() !== filter.trim()) {
                            matchesAllFilters = false
                        }
                    })
                }
                if (filterKey === 'abrev') {
                    filters.forEach(filter => {
                        if (deployment.Agency.trim() !== filter.trim()) {
                            matchesAllFilters = false
                        }
                    })
                }


            })
            if (matchesAllFilters) {
                matchedDeployments.push(deployment)
            }
        })

        return matchedDeployments
    }

    function formatData(data) {
        allCountryShapes = data[1]['features']

        allDeployments = data[0].reduce((acc, deployment) => {
            splitAgency = deployment.Agency.split(';')
            if (splitAgency.length > 1) {
                splitAgency.forEach((el, index) => {
                    newDeployment = JSON.parse(JSON.stringify(deployment));;
                    newDeployment.Agency = deployment.Agency.split(';')[index].trim()
                    newDeployment["Agency Full Name"] = deployment["Agency Full Name"].split(';')[index].trim()
                    acc.push(newDeployment)
                })
            } else {
                acc.push(deployment)
            }
            return acc
        }, []).sort(function (a, b) {
            return (a["Agency Full Name"].toUpperCase() > b["Agency Full Name"].toUpperCase()) ? 1 :
                ((b["Agency Full Name"].toUpperCase() > a["Agency Full Name"].toUpperCase()) ? -1 : 0);
        })


        allDeployments.forEach((dataEl) => {

            abrev = dataEl.Agency.trim()
            if (filterOptions.abrev.indexOf(abrev) === -1) {
                filterOptions.abrev.push(abrev)
            }

            name = dataEl['Agency Full Name'].trim()
            if (filterOptions.names.indexOf(name) === -1) {
                filterOptions.names.push(name)
            }

            const useCasePropName = 'Use case'
            if (useCasePropName in dataEl) {
                dataEl.useCases = dataEl[useCasePropName].split(';').map(el => {
                    return el.trim()
                })
            }
            const techPropName = 'Tech'
            if (techPropName in dataEl) {
                dataEl.technology = dataEl[techPropName].split(';').map(el => {
                    return el.trim()
                })
            }
        })

        var nestedDeployments = d3.nest()
            .key(function (d) { return d.Agency; })
            .entries(allDeployments);

        groupedSolutions = nestedDeployments.reduce((acc, element) => {
            acc[element.key] = element.values
            return acc
        }, {})


        filterOptions.useCases = uniqueProperties(allDeployments, 'useCases').sort()
        // console.log('filterOptions.useCases', filterOptions.useCases)
        filterOptions.tech = uniqueProperties(allDeployments, 'technology').sort()
        // console.log('filterOptions.tech', filterOptions.tech)
        filterOptions.status = uniqueProperties(allDeployments, 'Status').sort()
        // console.log('filterOptions.status', filterOptions.status)
        filterOptions.locations = uniqueProperties(allDeployments, 'Country').sort()
        // console.log('filterOptions.locations', filterOptions.locations)

    }

    function mapFormattedDeployments(deployments) {
        return deployments.reduce((acc, deployment) => {
            deployment.Country = deployment.Country.trim()

            var countryShape = allCountryShapes.filter(shape => {
                return shape.properties.country_name === deployment.Country |
                    (shape.properties.alternative_names.indexOf(deployment.Country) !== -1)
            })[0]

            if (countryShape !== undefined) {
                var foundShapeDeployment = acc.filter(shapeDeployments => {
                    return shapeDeployments.properties.country_name === countryShape.properties.country_name
                })[0]
                if (foundShapeDeployment !== undefined) {
                    foundShapeDeployment.properties.deployments.push(deployment)
                } else {
                    countryShape.properties.deployments = [deployment];
                    acc.push(countryShape)
                }
            } else { console.warn("Could Not Find Shape for Country", deployment.Country) }

            return acc
        }, []);
    }

    function displayDeployment(deploymentId) {
        var deployments = deploymentsMatchingFilters(groupedSolutions[deploymentId], selectedFilters)

        modal = $('.vendor').jBox('Modal', {
            maxWidth: 600
        });

        title = `<span class="vendor-modal-title-text">` + deployments[0]['Agency Full Name'] + `</span>
                <i class="fa fa-times vendor-modal-close-times" onclick="modal.close();"></i>`

        content = `
            <div class="sqs-row vendor-modal-logo"> 
                    <img src="`+ deployments[0].Image + `" class="vendor-modal-logo-image"> 
            </div>
            <br>
            <p><span><strong>Region:</strong> ` + deployments[0].Region + `</span></p>
            <p><span><strong>Country:</strong> ` + deployments[0].Country + `</span></p>
            <p><span><strong>Agency Type:</strong> ` + deployments[0]['Type of Agency'] + `</span></p>
            <br>`

        content += `<p><span><u><strong style="font-size: 14px; margin-bottom:15px;">Solution` + ((deployments.length > 1) ? `s (` + deployments.length + `)` : '') + `:</strong></u></span></p>  `

        deployments.forEach((deployment, index) => {
            content += `
            <div class="solution">
                <p><span><strong><i class="fa fa-list"></i> &nbsp; Use Cases:</strong> ` + deployment['Use case'] + `</span></p>
                <p><span><strong><i class="fa fa-check-circle"></i> &nbsp; Status:</strong> ` + deployment.Status + `</span></p>
                <p><span><strong><i class="fa fa-cogs"></i> &nbsp;Tech:</strong> ` + deployment.Tech + `</span></p>
                <p><span><strong><i class="fas fa-file-alt" aria-hidden="true"></i> &nbsp;&nbsp; Description:</strong> ` + deployment.Description + `</span></p>
            </div>
            `
            if (index != (deployments.length - 1)) {
                content += "<br>"
            }
        })
        modal.setTitle(title).setContent(content).open();
        customGA('send', 'event', 'Solutions', 'Display Details', deployments);

    }

</script>